# Phase 8 Final Devil's Advocate Audit: Comprehensive LIIMS Quality Gate

**Auditor:** Devil's Advocate Agent
**Date:** 2026-02-12
**Scope:** FULL codebase audit -- security, data integrity, API completeness, frontend completeness, Docker, performance, code quality
**Severity Scale:** C = Critical (must fix before user testing), W = Warning (should fix), I = Info (nice to have)

---

## Summary

| Severity | Count |
|----------|-------|
| Critical | 10    |
| Warning  | 14    |
| Info     | 8     |

---

## SECTION 1: Security Audit

### C-01: In-Memory Rate Limiter Does Not Work Across Workers (backend/app/core/rate_limit.py:74)

**Risk:** The `_SlidingWindowCounter` is a module-level singleton using `threading.Lock` and in-memory dicts. In production, gunicorn runs 4 workers (separate processes). Each worker has its own `_counter` instance, so rate limits are effectively multiplied by 4. An attacker gets `4 * max_calls` attempts. This renders login brute-force protection and account lockout nearly useless.

**Fix:** Use Redis-backed rate limiting (e.g., `redis` INCR with TTL, or `fastapi-limiter`) so all workers share state. The account lockout in-memory counter has the same flaw -- `record_failed_login` / `is_account_locked` are per-process.

---

### C-02: In-Memory Password Reset Tokens Lost on Restart / Not Shared (backend/app/services/auth.py:26)

**Risk:** Password reset tokens are stored in a module-level dict `_reset_tokens`. On container restart, all pending tokens are lost. With gunicorn multi-worker, a token generated by worker A cannot be validated by worker B. The code itself acknowledges this with `# In production this should use Redis` but it was never done.

**Fix:** Store reset tokens in Redis with a TTL, or in a database table.

---

### C-03: X-Forwarded-For IP Spoofing in Rate Limiter (backend/app/core/rate_limit.py:140-146)

**Risk:** `_get_ip()` trusts X-Forwarded-For blindly, taking the first value. An attacker can set `X-Forwarded-For: 1.2.3.4` to bypass all IP-based rate limits. The backend is configured with `--forwarded-allow-ips *` which trusts all sources.

**Fix:** Use `X-Real-IP` header (set by Nginx) as primary source. Or take the last IP in X-Forwarded-For (the proxy-appended one).

---

### C-04: ValueError Handler Exposes Internal Error Messages (backend/app/core/error_handlers.py:70-78)

**Risk:** The `value_error_handler` returns `str(exc)` directly to clients regardless of `DEBUG` mode. While intended for business-rule violations, any ValueError from SQLAlchemy internals, Pydantic, or library code is also caught and leaked.

**Fix:** Introduce a custom `BusinessRuleError(ValueError)` subclass and only catch that. Let other ValueErrors fall through to the generic handler which gates on DEBUG.

---

### C-05: Seed Data Prints Passwords to Stdout and Has No Production Guard (backend/app/seed.py:98-104, 1042-1044)

**Risk:** (a) All seed passwords are hardcoded in source (`Admin@123`, `Tech@123` etc.) and follow a predictable pattern. (b) The seeder prints all passwords in cleartext to stdout, which Docker captures in logs. (c) No guard prevents running the seeder in production (`DEBUG=false`).

**Fix:** Add a `DEBUG` guard. Generate random passwords at runtime. Never print passwords to stdout.

---

### C-06: Frontend Dockerfile Runs as Root (frontend/Dockerfile:29-40)

**Risk:** The Dockerfile sets up file ownership for `nginx` user but never issues `USER nginx`. Nginx runs as root inside the container.

**Fix:** Add `USER nginx` before CMD. Change nginx.conf to listen on a non-privileged port (8080) since non-root cannot bind port 80 inside the container.

---

### C-07: Report Generation Leaks Error Details (backend/app/api/v1/reports.py:261-265)

**Risk:** The `_generate_pdf` helper catches all exceptions and returns the raw error message to the client: `f"Report generation failed: {str(e)}"`. This can leak file paths, DB connection details, or WeasyPrint internal errors.

```python
except Exception as e:
    raise HTTPException(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        detail=f"Report generation failed: {str(e)}",
    )
```

**Fix:** Log the full exception server-side and return a generic message: "Report generation failed. Please try again or contact support."

---

### C-08: Scheduled Report Delete Is a Hard Delete (backend/app/api/v1/reports.py:205)

**Risk:** The delete endpoint calls `await db.delete(report)` which is a physical delete. SPEC section 3.1 mandates "Soft deletes everywhere: No physical deletes from the database." This violates the global convention and makes the deletion unrecoverable.

**Fix:** Add `is_deleted` column to `scheduled_report` table and use soft delete.

---

### C-09: Query Builder CSV Export Allows 50,000 Row Dump (backend/app/services/query_builder.py:228-246)

**Risk:** The `export_csv` method allows downloading up to 50,000 rows in a single request. While the query builder is gated by RBAC (super_admin, lab_manager, pi_researcher), there's no audit logging for exports. The SPEC mandates no "export buttons" except TECAN worklists and PDFs, but the query builder has a full CSV export.

**Fix:** Add audit logging for all query builder exports. If CSV export violates the SPEC's "no export buttons" rule, restrict to PDF only or get explicit sign-off from the PI.

---

### C-10: Account Lockout Enables Email Enumeration (backend/app/api/v1/auth.py:51-55)

**Risk:** The lockout check returns a distinct message ("Account temporarily locked due to too many failed attempts") that differs from the invalid credentials message. This confirms to an attacker that the email exists and has been targeted.

**Fix:** Return the same "Invalid email or password" message regardless. Check lockout silently server-side.

---

## SECTION 2: Data Integrity

### W-01: No `updated_at` Auto-Update Trigger (backend/alembic/versions/002_add_file_store_and_fixes.py:43)

`managed_file` and `watch_directory` tables have `updated_at` with `server_default=sa.func.now()` but no trigger or `onupdate` to refresh it. The column always shows creation time.

**Fix:** Add `onupdate=func.now()` in the SQLAlchemy model or a PostgreSQL trigger.

---

### W-02: Audit Logs Tied to Transaction (backend/app/services/audit.py:60)

`AuditService.log()` calls `self.db.add(entry)` without flushing. If the parent transaction rolls back, the audit entry is lost. Security-critical events (failed logins, permission denials) should survive rollbacks.

**Fix:** For critical events, use a separate DB session or async queue.

---

### W-03: text() SQL in partner.py Uses Parameterized Queries Correctly

The `text("similarity(participant.participant_code, :code) > 0.6").params(code=code)` usage in `backend/app/services/partner.py` is safe -- it uses SQLAlchemy bind parameters (`:code`), not string formatting. **No issue found.** Same applies to `participant.py` and `sample.py` similarity searches.

---

## SECTION 3: API Completeness vs SPEC.md

All 19 API route modules are registered in `backend/app/api/v1/__init__.py`:
auth, users, participants, collection_sites, samples, transports, notifications, settings, storage, labels, qr, field_events, partner, instruments, icc, dashboard, reports, query_builder, files, sync.

**Verified:** Every SPEC section has a corresponding API router. RBAC is applied on every single route file via `require_role()` or `get_current_active_user`. All 20 API files use auth dependencies.

### W-04: Missing SPEC API Endpoints

The following endpoints from SPEC section 4 may be missing or not verified in this pass:
- `POST /api/consents/{id}/withdraw` -- consent withdrawal triggering discard workflow
- `GET /api/participants/{id}/completion` -- completion checklist breakdown
- `POST /api/processing/start`, `POST /api/processing/aliquot`, `POST /api/processing/complete` -- processing session endpoints
- `POST /api/storage/release-lock` -- position lock release
- `GET /api/freezers/{id}/temperature-events`, `POST /api/freezers/{id}/temperature-events` -- temperature event logging

These are specified in SPEC but may be handled inline in existing routes or missing entirely. Needs manual verification during Phase 9.

---

## SECTION 4: Frontend Completeness vs SPEC.md Section 5

### W-05: 15 Frontend Pages Are Placeholders (frontend/src/router.tsx)

The following routes render `<PlaceholderPage>` (empty "under development" stubs):

1. `/participants/odk-sync` -- ODK Sync Status
2. `/samples/processing` -- Sample Processing (processing timer is a SPEC-critical feature)
3. `/field-ops/conflicts` -- Sync Conflicts
4. `/partners/results` -- Partner Results
5. `/instruments/queue` -- Sample Queue
6. `/reports/sites` -- Sites Dashboard
7. `/admin/users` -- User Management
8. `/admin/users/:id` -- User Detail
9. `/admin/replica` -- Read Replica Accounts
10. `/admin/audit-logs` -- Audit Logs
11. `/admin/access-logs` -- Access Logs
12. `/admin/reports` -- Scheduled Reports
13. `/admin/settings` -- System Settings
14. `/notifications` -- Notifications
15. `/profile` -- Profile

**Impact:** User management, system settings, audit logs, and notifications are admin-critical features. Sample processing with timers is a core workflow. These are not just nice-to-haves.

**Fix:** At minimum, `/admin/users`, `/admin/settings`, `/admin/audit-logs`, `/notifications`, and `/samples/processing` must be implemented before user testing.

---

## SECTION 5: Docker & Deployment

### W-06: Docker Compose Dev Uses Default Weak Passwords (docker-compose.yml:125)

PostgreSQL defaults to `password`, SECRET_KEY defaults to `change-me-in-production`. While there's a runtime check for SECRET_KEY, there's none for DB passwords.

**Fix:** Remove defaults for sensitive env vars or add startup validation.

---

### W-07: Redis Has No Authentication (docker-compose.yml, docker-compose.prod.yml)

Redis runs without `requirepass` in both environments. Any container on the network can read/write Redis.

**Fix:** Add `--requirepass ${REDIS_PASSWORD}` and update connection strings.

---

### W-08: Production Compose Missing Health Checks for App Services (docker-compose.prod.yml)

The production override doesn't define health checks for api, celery-worker, or celery-beat. The base compose's health check dependency may not carry over correctly with the override pattern.

**Fix:** Explicitly define health checks in the production override.

---

### W-09: Backend Docker Image Includes Build Toolchain (backend/Dockerfile:4-12)

`build-essential` remains in the final image (~100MB), providing tools an attacker could use if they gain container access.

**Fix:** Use multi-stage build: compile in builder stage, copy installed packages to clean slim image.

---

## SECTION 6: Performance

### W-10: No Database Connection Pooling Configuration (backend/app/config.py, database.py)

The async SQLAlchemy engine likely uses default pool settings. With 4 gunicorn workers, each creating its own pool, the total connections could exceed PostgreSQL's `max_connections=100` (prod compose).

**Fix:** Explicitly configure pool size in the engine creation. With 4 workers and default pool of 5+10 overflow, that's 60 connections which is fine, but should be documented and explicit.

---

### W-11: Query Builder Has No Result Size Limit on Execute (backend/app/services/query_builder.py:131)

The `execute_query` accepts `per_page` up to whatever the schema allows (likely uncapped at the Pydantic level). While CSV export caps at 50,000, the JSON execute path could return enormous payloads if `per_page=100000` is sent.

**Fix:** Enforce `per_page` max (e.g., 1000) in the Pydantic schema or service layer.

---

## SECTION 7: Code Quality

### W-12: Celery Tasks Use Deprecated asyncio Pattern (backend/app/tasks/files.py:84, 108)

`asyncio.get_event_loop().run_until_complete()` is deprecated in Python 3.12+. The fallback with `asyncio.new_event_loop()` creates but doesn't set the current loop.

**Fix:** Use `asyncio.run()`.

---

### W-13: Duplicated _paginate_meta Helper (multiple files)

The `_paginate_meta` function is copy-pasted identically across `files.py`, `reports.py`, `query_builder.py`, and likely others. This is a maintenance burden.

**Fix:** Extract to a shared utility module like `app/core/pagination.py`.

---

### W-14: Root nginx.conf vs Frontend nginx.conf Unclear Topology (nginx.conf, frontend/nginx.conf)

Two nginx configs serve overlapping purposes without documentation. The root `nginx.conf` is a standalone reverse proxy; the frontend's is an in-container config. Developers may not know which to modify.

**Fix:** Add comments explaining each file's deployment context.

---

## SECTION 8: Info / Minor Issues

### I-01: Seed Data Uses Random Without Fixed Seed (backend/app/seed.py)

Every seeder run produces different data, making it hard to write deterministic tests.

### I-02: ErrorBoundary Dev Stack Trace (frontend/src/components/ErrorBoundary.tsx:65-71)

Correctly gated by `import.meta.env.DEV`. No issue, just verify Vite production builds strip this.

### I-03: Health Check Endpoint Leaks Internal Error Details (backend/app/main.py:82, 95)

Returns `str(exc)[:200]` for DB/Redis errors -- can reveal hostnames and versions.

### I-04: Rate Limiter Memory Cleanup Never Called (backend/app/core/rate_limit.py:60-70)

The `cleanup()` method exists but is never invoked. Slow memory leak over time.

### I-05: No Request Body Size Limit on FastAPI (backend/app/main.py)

Nginx handles this in production, but the API itself has no defense-in-depth limit.

### I-06: CORS `allow_credentials=True` Without Strict Origin Lock

While JWT bearer tokens mitigate CSRF, `allow_credentials=True` with configurable origins could be problematic if origins are misconfigured.

### I-07: Migration Downgrade Order Could Be Cleaner (backend/alembic/versions/002_add_file_store_and_fixes.py:76-81)

Indexes are implicitly dropped with tables, but explicit `drop_index()` calls would be clearer.

### I-08: PlaceholderPage Component Has No Lazy Loading

Placeholder pages are imported eagerly in router.tsx. When they're replaced with real implementations, consider lazy-loading heavy pages.

---

## Positive Observations

1. **RBAC on every route** -- All 20 API files use `require_role()` or `get_current_active_user`. No unprotected endpoints.
2. **Session revocation** -- JWT sessions are tracked in DB with revocation support. Password change revokes all sessions.
3. **Security headers middleware** -- CSP, HSTS, X-Frame-Options, Permissions-Policy all properly set.
4. **SECRET_KEY startup check** -- App refuses to start with default key in production.
5. **Query builder uses allowlists** -- Column and operator allowlists prevent SQL injection in the dynamic query builder.
6. **SQL `text()` uses bind parameters** -- All `similarity()` calls use `:search` / `:code` bind params, not string formatting.
7. **Parameterized ILIKE** -- `_escape_ilike()` is used consistently across services.
8. **Partner CSV import has size limit** -- 10MB max enforced at the API layer.
9. **Soft delete pattern** -- Consistently applied across models with `is_deleted` filter in queries.
10. **Seed data is idempotent** -- Checks for existing data before inserting.
11. **Docker production compose** -- Resource limits, structured logging, separate networks, PostgreSQL tuning.
12. **Frontend RoleGuard** -- Client-side RBAC guards complement backend RBAC.
13. **Forgot-password anti-enumeration** -- Always returns success regardless of email existence.

---

## Files Audited

### Backend Core
| File | Status |
|------|--------|
| `backend/app/core/error_handlers.py` | C-04 |
| `backend/app/core/rate_limit.py` | C-01, C-03, I-04 |
| `backend/app/core/sanitize.py` | Clean |
| `backend/app/core/security.py` | Clean |
| `backend/app/core/middleware.py` | Clean |
| `backend/app/core/deps.py` | Clean -- RBAC verified |
| `backend/app/config.py` | Clean |

### Backend Services
| File | Status |
|------|--------|
| `backend/app/services/audit.py` | W-02 |
| `backend/app/services/auth.py` | C-02 |
| `backend/app/services/file_store.py` | Clean |
| `backend/app/services/query_builder.py` | C-09, W-11 |
| `backend/app/services/partner.py` | Clean (SQL safe) |
| `backend/app/services/report.py` | Reviewed via route |

### Backend API Routes
| File | Status |
|------|--------|
| `backend/app/api/v1/auth.py` | C-10 |
| `backend/app/api/v1/files.py` | Clean |
| `backend/app/api/v1/reports.py` | C-07, C-08 |
| `backend/app/api/v1/query_builder.py` | Clean (RBAC OK) |
| `backend/app/api/v1/dashboard.py` | Clean (RBAC OK) |
| `backend/app/api/v1/sync.py` | Clean (RBAC OK) |
| `backend/app/api/v1/instruments.py` | Clean |
| All 20 route files | RBAC verified present |

### Backend Other
| File | Status |
|------|--------|
| `backend/app/main.py` | I-03, I-05 |
| `backend/app/seed.py` | C-05 |
| `backend/app/tasks/files.py` | W-12 |
| `backend/alembic/versions/002_*.py` | W-01, I-07 |

### Infrastructure
| File | Status |
|------|--------|
| `docker-compose.yml` | W-06, W-07 |
| `docker-compose.prod.yml` | W-07, W-08 |
| `backend/Dockerfile` | W-09 |
| `frontend/Dockerfile` | C-06 |
| `frontend/nginx.conf` | W-14 |
| `nginx.conf` (root) | W-14 |
| `.env.example` | Clean |
| `backend/.dockerignore` | Clean |
| `frontend/.dockerignore` | Clean |

### Frontend
| File | Status |
|------|--------|
| `frontend/src/router.tsx` | W-05 (15 placeholders) |
| `frontend/src/components/ErrorBoundary.tsx` | I-02 |
| `frontend/src/pages/ForbiddenPage.tsx` | Clean |
